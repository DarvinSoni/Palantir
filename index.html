<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Palantir - 3D Asteroid Impact Simulator</title>
    <link rel="stylesheet" href="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Widgets/widgets.css">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/Cesium.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #ff4444;
            --secondary-color: #ff8800;
            --bg-dark: #0a0e27;
            --bg-panel: rgba(15, 20, 45, 0.95);
            --text-light: #ffffff;
            --text-dim: #a0a0a0;
            --success: #00ff88;
            --warning: #ffaa00;
            --danger: #ff4444;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: var(--text-light);
            overflow: hidden;
            height: 100vh;
        }

        #cesiumContainer {
            width: 100%;
            height: 100vh;
            position: relative;
            z-index: 1;
        }

        .cesium-viewer-bottom {
            display: none !important;
        }

        .cesium-widget-credits {
            display: none !important;
        }

        .cesium-viewer .cesium-viewer-cesiumWidgetContainer .cesium-credit-textContainer {
            display: none !important;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            font-size: 18px;
            color: var(--text-light);
        }

        .loading-subtext {
            margin-top: 10px;
            font-size: 14px;
            color: var(--text-dim);
        }

        .control-panel {
            position: fixed;
            top: 20px;
            left: 20px;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            max-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .control-panel::-webkit-scrollbar {
            width: 8px;
        }

        .control-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .control-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        h1 {
            font-size: 28px;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 20px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-size: 13px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .value-display {
            float: right;
            color: var(--text-light);
            font-weight: bold;
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255, 255, 255, 0.1);
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(255, 68, 68, 0.5);
            border: none;
        }

        select {
            width: 100%;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: var(--text-light);
            font-size: 14px;
            cursor: pointer;
        }

        select option {
            background: var(--bg-dark);
        }

        button {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border: none;
            border-radius: 8px;
            color: var(--text-light);
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 10px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        .preset-button {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            font-size: 13px;
            margin-top: 5px;
        }

        .preset-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .info-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            max-width: 350px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        .info-panel::-webkit-scrollbar {
            width: 8px;
        }

        .info-panel::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .info-panel::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
        }

        .stat {
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            border-left: 3px solid var(--primary-color);
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 20px;
            font-weight: bold;
            color: var(--text-light);
        }

        .stat-unit {
            font-size: 12px;
            color: var(--text-dim);
            margin-left: 5px;
        }

        .instruction {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 999;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.1);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.02); }
        }

        .instruction h2 {
            font-size: 24px;
            margin-bottom: 15px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .instruction p {
            color: var(--text-dim);
            font-size: 14px;
        }

        .hidden {
            display: none;
        }

        .energy-display {
            font-size: 14px;
            padding: 10px;
            background: rgba(255, 136, 0, 0.1);
            border-radius: 8px;
            border-left: 3px solid var(--secondary-color);
            margin-top: 10px;
        }

        .view-mode-toggle {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            padding: 12px 25px;
            border-radius: 50px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
            z-index: 1000;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .view-button {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .view-button.active {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            border-color: transparent;
        }

        .impact-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 500;
        }

        @keyframes flash {
            0% { background: rgba(255, 255, 255, 0); }
            50% { background: rgba(255, 100, 0, 0.8); }
            100% { background: rgba(255, 0, 0, 0); }
        }

        .impact-flash {
            animation: flash 1s ease-out;
        }

        .error-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-panel);
            padding: 30px;
            border-radius: 15px;
            border: 2px solid var(--danger);
            z-index: 10000;
            max-width: 500px;
            text-align: center;
        }

        .error-message h3 {
            color: var(--danger);
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Loading 3D Earth...</div>
        <div class="loading-subtext">Please wait while we initialize the globe</div>
    </div>

    <div id="cesiumContainer"></div>
    <div class="impact-overlay" id="impactOverlay"></div>

    <div class="instruction" id="instruction">
        <h2>üåç Drop an Asteroid in 3D</h2>
        <p>Click anywhere on the globe to unleash devastation and watch the destruction unfold</p>
    </div>

    <div class="control-panel">
        <h1>‚ö° Palantir 3D</h1>
        <p class="subtitle">3D Asteroid Impact Simulator</p>

        <div class="control-group">
            <label>
                Asteroid Diameter
                <span class="value-display" id="diameter-display">100 m</span>
            </label>
            <input type="range" id="diameter" min="10" max="10000" value="100" step="10">
        </div>

        <div class="control-group">
            <label>
                Impact Velocity
                <span class="value-display" id="velocity-display">20 km/s</span>
            </label>
            <input type="range" id="velocity" min="11" max="72" value="20" step="1">
        </div>

        <div class="control-group">
            <label>
                Impact Angle
                <span class="value-display" id="angle-display">45¬∞</span>
            </label>
            <input type="range" id="angle" min="15" max="90" value="45" step="5">
        </div>

        <div class="control-group">
            <label>Asteroid Composition</label>
            <select id="composition">
                <option value="7800">Iron (7,800 kg/m¬≥)</option>
                <option value="3000">Stone (3,000 kg/m¬≥)</option>
                <option value="1000">Ice (1,000 kg/m¬≥)</option>
                <option value="2000">Carbon-rich (2,000 kg/m¬≥)</option>
            </select>
        </div>

        <div class="control-group">
            <label>Impact Location</label>
            <select id="target-type">
                <option value="land">Land</option>
                <option value="water">Water (Ocean)</option>
            </select>
        </div>

        <button id="random-btn">üé≤ Random Asteroid</button>
        <button id="clear-btn">üóëÔ∏è Clear Impact</button>

        <div class="control-group" style="margin-top: 20px;">
            <label>Famous Asteroids</label>
            <button class="preset-button" data-preset="tunguska">Tunguska Event (1908)</button>
            <button class="preset-button" data-preset="chelyabinsk">Chelyabinsk (2013)</button>
            <button class="preset-button" data-preset="barringer">Barringer Crater</button>
            <button class="preset-button" data-preset="chicxulub">Chicxulub (Dinosaurs)</button>
        </div>
    </div>

    <div class="info-panel">
        <h2>üìä Impact Results</h2>
        <div id="results">
            <div class="stat">
                <div class="stat-label">Impact Energy</div>
                <div class="stat-value">
                    <span id="energy">-</span>
                    <span class="stat-unit">Megatons</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Crater Diameter</div>
                <div class="stat-value">
                    <span id="crater">-</span>
                    <span class="stat-unit">meters</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Fireball Radius</div>
                <div class="stat-value">
                    <span id="fireball">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Air Blast Radius</div>
                <div class="stat-value">
                    <span id="blast">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Thermal Radiation</div>
                <div class="stat-value">
                    <span id="thermal">-</span>
                    <span class="stat-unit">km</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Seismic Effect</div>
                <div class="stat-value">
                    <span id="seismic">-</span>
                    <span class="stat-unit">Richter</span>
                </div>
            </div>

            <div class="stat">
                <div class="stat-label">Buildings Destroyed</div>
                <div class="stat-value" style="color: var(--danger);">
                    <span id="buildings">-</span>
                </div>
            </div>

            <div class="energy-display">
                <strong>Energy Comparison:</strong><br>
                <span id="comparison">-</span>
            </div>

            <div class="stat" style="border-left-color: var(--danger);">
                <div class="stat-label">Estimated Casualties</div>
                <div class="stat-value" style="color: var(--danger);">
                    <span id="casualties">-</span>
                </div>
            </div>
        </div>
    </div>

    <div class="view-mode-toggle">
        <span style="font-size: 12px; color: var(--text-dim);">Camera:</span>
        <button class="view-button active" id="orbitalView">üõ∞Ô∏è Orbital</button>
        <button class="view-button" id="groundView">üëÅÔ∏è Ground</button>
    </div>

    <script>
        // Configure Cesium to prevent worker errors
        window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.109/Build/Cesium/';
        
        let viewer;
        let currentEntities = [];
        let impactLocation = null;
        const loadingScreen = document.getElementById('loadingScreen');

        // Initialize Cesium viewer with error handling
        try {
            // Create viewer with basic configuration
            viewer = new Cesium.Viewer('cesiumContainer', {
                animation: false,
                baseLayerPicker: false,
                fullscreenButton: false,
                vrButton: false,
                geocoder: false,
                homeButton: false,
                infoBox: false,
                sceneModePicker: false,
                selectionIndicator: false,
                timeline: false,
                navigationHelpButton: false,
                shouldAnimate: true,
                imageryProvider: false, // Start without imagery
                terrainProvider: new Cesium.EllipsoidTerrainProvider(),
                requestRenderMode: false, // Disable to force continuous rendering
                contextOptions: {
                    webgl: {
                        alpha: false,
                        depth: true,
                        stencil: false,
                        antialias: true,
                        powerPreference: "high-performance"
                    }
                }
            });

            console.log('Cesium viewer created');

            // FORCE globe to be visible and render
            viewer.scene.globe.show = true;
            viewer.scene.skyBox.show = true;
            viewer.scene.sun.show = true;
            viewer.scene.moon.show = true;
            viewer.scene.skyAtmosphere.show = true;
            
            // Set globe base color (will show even without imagery)
            viewer.scene.globe.baseColor = Cesium.Color.DODGERBLUE;
            viewer.scene.globe.enableLighting = false;
            viewer.scene.globe.showGroundAtmosphere = true;
            
            // Set background color
            viewer.scene.backgroundColor = Cesium.Color.BLACK;
            
            // Force initial render
            viewer.scene.requestRender();
            
            console.log('Globe visibility forced');
            
            // Add OpenStreetMap imagery AFTER a delay
            setTimeout(() => {
                try {
                    viewer.imageryLayers.addImageryProvider(
                        new Cesium.UrlTemplateImageryProvider({
                            url: 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            subdomains: ['a', 'b', 'c'],
                            maximumLevel: 19
                        })
                    );
                    console.log('OpenStreetMap imagery loaded');
                    viewer.scene.requestRender();
                } catch (imgError) {
                    console.warn('Could not load OpenStreetMap:', imgError);
                }
            }, 1000);
            
            console.log('Globe configured and visible');

            // Set initial camera view - closer to see the globe better
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(-74.0060, 40.7128, 20000000),
                orientation: {
                    heading: 0.0,
                    pitch: -Cesium.Math.PI_OVER_TWO,
                    roll: 0.0
                }
            });

            // Add a test entity to verify 3D rendering works
            viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(-74.0, 40.7, 1000000),
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: 'TEST MARKER',
                    font: '14px sans-serif',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2,
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -20)
                }
            });

            console.log('Test marker added');

            // Hide loading screen after globe is ready
            setTimeout(() => {
                loadingScreen.classList.add('hidden');
                console.log('Cesium viewer initialized successfully');
                console.log('Globe show:', viewer.scene.globe.show);
                console.log('Globe baseColor:', viewer.scene.globe.baseColor);
            }, 2000);

        } catch (error) {
            console.error('Error initializing Cesium:', error);
            loadingScreen.innerHTML = `
                <div class="error-message">
                    <h3>‚ö†Ô∏è Loading Error</h3>
                    <p>Could not initialize 3D Earth viewer.</p>
                    <p style="margin-top: 10px; font-size: 12px; color: var(--text-dim);">
                        ${error.message}
                    </p>
                    <button onclick="location.reload()" style="margin-top: 20px; width: auto; padding: 10px 20px;">
                        Retry
                    </button>
                </div>
            `;
        }

        // Get elements
        const diameterSlider = document.getElementById('diameter');
        const velocitySlider = document.getElementById('velocity');
        const angleSlider = document.getElementById('angle');
        const compositionSelect = document.getElementById('composition');
        const targetTypeSelect = document.getElementById('target-type');
        const instruction = document.getElementById('instruction');
        const impactOverlay = document.getElementById('impactOverlay');

        // Update displays
        diameterSlider.addEventListener('input', (e) => {
            document.getElementById('diameter-display').textContent = e.target.value + ' m';
        });

        velocitySlider.addEventListener('input', (e) => {
            document.getElementById('velocity-display').textContent = e.target.value + ' km/s';
        });

        angleSlider.addEventListener('input', (e) => {
            document.getElementById('angle-display').textContent = e.target.value + '¬∞';
        });

        // Physics calculations
        function calculateImpact(diameter, velocity, angle, density, targetType) {
            const radius = diameter / 2;
            const volume = (4/3) * Math.PI * Math.pow(radius, 3);
            const mass = volume * density;
            
            const velocityMs = velocity * 1000;
            const energy = 0.5 * mass * Math.pow(velocityMs, 2);
            const energyMegatons = energy / (4.184e15);
            
            const angleRad = angle * Math.PI / 180;
            const targetFactor = targetType === 'water' ? 1.3 : 1.0;
            const craterDiameter = Math.pow(energy / 1e15, 0.3) * Math.sin(angleRad) * targetFactor * 1000;
            
            const fireballRadius = 0.028 * Math.pow(energyMegatons, 0.33);
            const blastRadius = 0.22 * Math.pow(energyMegatons, 0.33);
            const thermalRadius = 0.67 * Math.pow(energyMegatons, 0.41);
            const seismic = 0.67 * Math.log10(energyMegatons) + 3.87;
            
            return {
                energy: energyMegatons,
                craterDiameter: craterDiameter,
                fireballRadius: fireballRadius,
                blastRadius: blastRadius,
                thermalRadius: thermalRadius,
                seismic: seismic,
                mass: mass
            };
        }

        function getEnergyComparison(megatons) {
            if (megatons < 0.001) {
                const tons = megatons * 1e6;
                return `${tons.toFixed(0)} tons of TNT`;
            } else if (megatons < 0.015) {
                const kilotons = megatons * 1000;
                return `${kilotons.toFixed(1)} kilotons (Small nuclear weapon)`;
            } else if (megatons < 1) {
                const kilotons = megatons * 1000;
                return `${kilotons.toFixed(0)} kilotons (Hiroshima was 15 kt)`;
            } else if (megatons < 50) {
                return `${megatons.toFixed(1)} megatons (Large nuclear weapon)`;
            } else if (megatons < 10000) {
                const factor = (megatons / 50).toFixed(0);
                return `${megatons.toFixed(0)} megatons (${factor}x largest nuclear test)`;
            } else {
                const factor = (megatons / 100000000).toFixed(2);
                return `${megatons.toFixed(0)} megatons (${factor}x Chicxulub impact)`;
            }
        }

        async function estimateCasualties(blastRadius) {
            const avgPopDensity = 5000;
            const affectedArea = Math.PI * Math.pow(blastRadius, 2);
            const estimated = Math.floor(affectedArea * avgPopDensity);
            
            if (estimated < 1000) return `${estimated} people`;
            if (estimated < 1000000) return `${(estimated / 1000).toFixed(0)}K people`;
            return `${(estimated / 1000000).toFixed(1)}M people`;
        }

        // Clear impact
        function clearImpact() {
            if (!viewer) return;
            currentEntities.forEach(entity => viewer.entities.remove(entity));
            currentEntities = [];
        }

        // Create explosion effect
        function createExplosion(position, energy) {
            impactOverlay.classList.add('impact-flash');
            setTimeout(() => {
                impactOverlay.classList.remove('impact-flash');
            }, 1000);

            const marker = viewer.entities.add({
                position: position,
                point: {
                    pixelSize: 20,
                    color: Cesium.Color.ORANGE.withAlpha(0.9),
                    outlineColor: Cesium.Color.RED,
                    outlineWidth: 3,
                    disableDepthTestDistance: Number.POSITIVE_INFINITY
                }
            });
            currentEntities.push(marker);
        }

        // Create damage zones
        function createDamageZones(position, impact) {
            const zones = [
                { radius: impact.fireballRadius * 1000, color: Cesium.Color.RED.withAlpha(0.3), label: 'Fireball' },
                { radius: impact.blastRadius * 1000, color: Cesium.Color.ORANGE.withAlpha(0.2), label: 'Blast' },
                { radius: impact.thermalRadius * 1000, color: Cesium.Color.YELLOW.withAlpha(0.15), label: 'Thermal' }
            ];

            zones.forEach((zone, index) => {
                const circle = viewer.entities.add({
                    position: position,
                    ellipse: {
                        semiMajorAxis: zone.radius,
                        semiMinorAxis: zone.radius,
                        material: zone.color,
                        outline: true,
                        outlineColor: zone.color.brighten(0.5, new Cesium.Color()),
                        outlineWidth: 2,
                        height: 0
                    },
                    label: {
                        text: zone.label,
                        font: '14px sans-serif',
                        fillColor: Cesium.Color.WHITE,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                        pixelOffset: new Cesium.Cartesian2(0, -20),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
                currentEntities.push(circle);
            });

            // Crater
            const crater = viewer.entities.add({
                position: position,
                ellipse: {
                    semiMajorAxis: impact.craterDiameter / 2,
                    semiMinorAxis: impact.craterDiameter / 2,
                    material: Cesium.Color.BLACK.withAlpha(0.5),
                    outline: true,
                    outlineColor: Cesium.Color.DARKRED,
                    outlineWidth: 3,
                    height: -50
                }
            });
            currentEntities.push(crater);
        }

        // Simulate building destruction
        function destroyBuildings(position, blastRadius) {
            const avgBuildingDensity = 50;
            const affectedArea = Math.PI * Math.pow(blastRadius, 2);
            const buildingsDestroyed = Math.floor(affectedArea * avgBuildingDensity);
            
            document.getElementById('buildings').textContent = buildingsDestroyed.toLocaleString();

            const cartographic = Cesium.Cartographic.fromCartesian(position);

            // Create simple 3D building representations in the impact zone
            const numBuildings = Math.min(30, Math.floor(blastRadius * 8));
            for (let i = 0; i < numBuildings; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * blastRadius * 1000 * 0.8;
                
                const buildingLon = cartographic.longitude + (distance / 6371000) * Math.cos(angle);
                const buildingLat = cartographic.latitude + (distance / 6371000) * Math.sin(angle);
                const buildingHeight = Math.random() * 60 + 20;
                
                // Create building as a box
                const building = viewer.entities.add({
                    position: Cesium.Cartesian3.fromRadians(buildingLon, buildingLat, buildingHeight / 2),
                    box: {
                        dimensions: new Cesium.Cartesian3(15, 15, buildingHeight),
                        material: Cesium.Color.DARKGRAY.withAlpha(0.3),
                        outline: true,
                        outlineColor: Cesium.Color.BLACK
                    }
                });
                currentEntities.push(building);
            }

            // Create debris particles
            const numDebris = Math.min(100, Math.floor(blastRadius * 15));
            for (let i = 0; i < numDebris; i++) {
                const angle = (Math.PI * 2 * i) / numDebris;
                const distance = Math.random() * blastRadius * 1000;
                
                const debrisLon = cartographic.longitude + (distance / 6371000) * Math.cos(angle);
                const debrisLat = cartographic.latitude + (distance / 6371000) * Math.sin(angle);
                const debrisHeight = Math.random() * 30 + 5;
                
                const debrisPosition = Cesium.Cartesian3.fromRadians(debrisLon, debrisLat, debrisHeight);
                
                const debris = viewer.entities.add({
                    position: debrisPosition,
                    point: {
                        pixelSize: Math.random() * 8 + 3,
                        color: Cesium.Color.fromRandom({ alpha: 0.7 }),
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
                currentEntities.push(debris);
            }

            // Add smoke/dust clouds with varied heights
            const numClouds = Math.min(40, Math.floor(blastRadius * 8));
            for (let i = 0; i < numClouds; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * blastRadius * 1000 * 0.6;
                
                const cloudLon = cartographic.longitude + (distance / 6371000) * Math.cos(angle);
                const cloudLat = cartographic.latitude + (distance / 6371000) * Math.sin(angle);
                const cloudHeight = Math.random() * 1000 + 200;
                
                const cloudPosition = Cesium.Cartesian3.fromRadians(cloudLon, cloudLat, cloudHeight);
                
                const cloudSize = Math.random() * 150 + 80;
                const cloud = viewer.entities.add({
                    position: cloudPosition,
                    ellipsoid: {
                        radii: new Cesium.Cartesian3(cloudSize, cloudSize, cloudSize * 0.8),
                        material: Cesium.Color.DARKGRAY.withAlpha(Math.random() * 0.4 + 0.2)
                    }
                });
                currentEntities.push(cloud);
            }

            // Add fire effects near impact
            const numFires = Math.min(20, Math.floor(blastRadius * 4));
            for (let i = 0; i < numFires; i++) {
                const angle = Math.random() * Math.PI * 2;
                const distance = Math.random() * blastRadius * 400;
                
                const fireLon = cartographic.longitude + (distance / 6371000) * Math.cos(angle);
                const fireLat = cartographic.latitude + (distance / 6371000) * Math.sin(angle);
                
                const fire = viewer.entities.add({
                    position: Cesium.Cartesian3.fromRadians(fireLon, fireLat, 20),
                    point: {
                        pixelSize: 12,
                        color: Cesium.Color.ORANGE.withAlpha(0.8),
                        outlineColor: Cesium.Color.RED,
                        outlineWidth: 2,
                        disableDepthTestDistance: Number.POSITIVE_INFINITY
                    }
                });
                currentEntities.push(fire);
            }
        }

        // Animate camera to impact
        function animateCameraToImpact(position, blastRadius) {
            const distance = Math.max(blastRadius * 3000, 5000);
            
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromRadians(
                    Cesium.Cartographic.fromCartesian(position).longitude,
                    Cesium.Cartographic.fromCartesian(position).latitude,
                    distance
                ),
                orientation: {
                    heading: Cesium.Math.toRadians(0),
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0.0
                },
                duration: 3
            });
        }

        // Handle click
        const handler = new Cesium.ScreenSpaceEventHandler(viewer.scene.canvas);
        handler.setInputAction(function(click) {
            instruction.classList.add('hidden');
            
            const ray = viewer.camera.getPickRay(click.position);
            const position = viewer.scene.globe.pick(ray, viewer.scene);
            
            if (Cesium.defined(position)) {
                clearImpact();
                impactLocation = position;
                
                const diameter = parseFloat(diameterSlider.value);
                const velocity = parseFloat(velocitySlider.value);
                const angle = parseFloat(angleSlider.value);
                const density = parseFloat(compositionSelect.value);
                const targetType = targetTypeSelect.value;
                
                const impact = calculateImpact(diameter, velocity, angle, density, targetType);
                
                // Update UI
                document.getElementById('energy').textContent = impact.energy.toExponential(2);
                document.getElementById('crater').textContent = impact.craterDiameter.toFixed(0);
                document.getElementById('fireball').textContent = impact.fireballRadius.toFixed(2);
                document.getElementById('blast').textContent = impact.blastRadius.toFixed(2);
                document.getElementById('thermal').textContent = impact.thermalRadius.toFixed(2);
                document.getElementById('seismic').textContent = impact.seismic.toFixed(1);
                document.getElementById('comparison').textContent = getEnergyComparison(impact.energy);
                
                estimateCasualties(impact.blastRadius).then(casualties => {
                    document.getElementById('casualties').textContent = casualties;
                });
                
                // Visual effects
                createExplosion(position, impact.energy);
                createDamageZones(position, impact);
                destroyBuildings(position, impact.blastRadius);
                animateCameraToImpact(position, impact.blastRadius);
            }
        }, Cesium.ScreenSpaceEventType.LEFT_CLICK);

        // Random asteroid
        document.getElementById('random-btn').addEventListener('click', () => {
            const randomDiameter = Math.floor(Math.random() * 2000) + 50;
            const randomVelocity = Math.floor(Math.random() * 50) + 15;
            const randomAngle = Math.floor(Math.random() * 75) + 15;
            
            diameterSlider.value = randomDiameter;
            velocitySlider.value = randomVelocity;
            angleSlider.value = randomAngle;
            
            document.getElementById('diameter-display').textContent = randomDiameter + ' m';
            document.getElementById('velocity-display').textContent = randomVelocity + ' km/s';
            document.getElementById('angle-display').textContent = randomAngle + '¬∞';
        });

        // Clear button
        document.getElementById('clear-btn').addEventListener('click', () => {
            clearImpact();
            impactLocation = null;
        });

        // Presets
        const presets = {
            tunguska: { diameter: 60, velocity: 27, angle: 45, density: 1000 },
            chelyabinsk: { diameter: 20, velocity: 19, angle: 18, density: 3500 },
            barringer: { diameter: 50, velocity: 12.8, angle: 45, density: 7800 },
            chicxulub: { diameter: 10000, velocity: 20, angle: 60, density: 3000 }
        };

        document.querySelectorAll('.preset-button').forEach(button => {
            button.addEventListener('click', () => {
                const preset = presets[button.dataset.preset];
                diameterSlider.value = preset.diameter;
                velocitySlider.value = preset.velocity;
                angleSlider.value = preset.angle;
                compositionSelect.value = preset.density;
                
                document.getElementById('diameter-display').textContent = preset.diameter + ' m';
                document.getElementById('velocity-display').textContent = preset.velocity + ' km/s';
                document.getElementById('angle-display').textContent = preset.angle + '¬∞';
            });
        });

        // Camera views
        document.getElementById('orbitalView').addEventListener('click', function() {
            if (impactLocation && viewer) {
                animateCameraToImpact(impactLocation, parseFloat(document.getElementById('blast').textContent));
            }
            this.classList.add('active');
            document.getElementById('groundView').classList.remove('active');
        });

        document.getElementById('groundView').addEventListener('click', function() {
            if (impactLocation && viewer) {
                const cartographic = Cesium.Cartographic.fromCartesian(impactLocation);
                const blastRadius = parseFloat(document.getElementById('blast').textContent) * 1000;
                
                const groundDistance = blastRadius * 1.5;
                const groundLon = cartographic.longitude + (groundDistance / 6371000);
                
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromRadians(
                        groundLon,
                        cartographic.latitude,
                        50
                    ),
                    orientation: {
                        heading: Cesium.Math.toRadians(270),
                        pitch: Cesium.Math.toRadians(-10),
                        roll: 0.0
                    },
                    duration: 3
                });
            }
            this.classList.add('active');
            document.getElementById('orbitalView').classList.remove('active');
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.key === 'r' || e.key === 'R') {
                document.getElementById('random-btn').click();
            } else if (e.key === 'c' || e.key === 'C') {
                clearImpact();
            }
        });
    </script>
</body>
</html>
